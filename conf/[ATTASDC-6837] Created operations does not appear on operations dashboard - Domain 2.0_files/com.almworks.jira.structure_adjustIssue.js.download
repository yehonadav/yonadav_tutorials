;
/* module-key = 'com.almworks.jira.structure:adjustIssue', location = 'js/structure/issue-page.js' */
ï»¿define("structure/page/issue/IssuePageUtil",[],function(){return{isCollapsedModule:function(b){var a=window.localStorage;if(a)try{var c=a.getItem("block-states");if("string"===typeof c)return! !c&&0<=c.indexOf(b)}catch(d){}return!1}}});define("structure/page/issue/TimeTrackingController",["almworks/jquery","underscore","almworks/util/Cell","almworks/util/Util","structure/page/issue/IssuePageUtil"],function(b,a,c,d,v){function e(a){a.find("#tt_structure_table_info dt").text(function(a,c){return "\u03a3\u00a0"+b.trim(c)})}function q(a){var c=b("#timetrackingmodule");c.length||(c=b("#datesmodule"));c.length||(c=b("#peoplemodule"));c.length?a.insertAfter(c):a.appendTo("#viewissuesidebar")}function y(a){var b=window.JIRA,c=window.AJS;if(b&&b.trigger&&c&&c.$&&a&&a[0])try{b.trigger(b.Events.NEW_CONTENT_ADDED,[c.$(a[0]),"timeTrackingPanelUpdatedByStructure"])}catch(f){d.warn("caught exception when notifying about page change",f)}}function x(){b("#s-timetrackingmodule").hide();b("#timetrackingmodule").show()}var f=namespace("almworks.structure"),z=namespace("almworks.structure.appevents");return function(B,p){function r(l){l=l.find("#s-timetrackingmodule");e(l);var a=b(
"#timetrackingmodule");if(k||l.length){var g,f=null;a.length&&(f=a.find(".mod-content").html(),g=a.find("#log-work-link").attr("href"),a.hide());var s= !1;if(k){a=k.find("#tt_structure_table_info");if(a.length){var D=l.find("#tt_structure_table_info");D.length&&(g=l.find("#log-work-link").attr("href"),a.html(D.html()),s= !0)}g&&k.find("#log-work-link").attr("href",g);d.onPage(k)||q(k)}else d.assert(l.length),A||(A=l.find("#tt_info_non_structure").html()),k=l,q(k),g=v.isCollapsedModule("#s-timetrackingmodule"),k.addClass(g?"collapsed":"expanded"),s= ! !k.find("#tt_structure_table_info").length;g=f||A;var C=k.find("#tt_info_non_structure");C.html()!==g&&(C.html(g),b("#tt_include_subtasks input",C).click(function(){var a=b(this).is(":checked");b("#tt_info_single",C).toggle(!a);b("#tt_info_aggregate",C).toggle(a)}));c.multiUpdate(function(){H.setValue(s);I.setValue(! !f)});w();y(k)}else a.show()}function w(){var a=b("#cb_tt_use_structure");g?g.setView(a):(t.setValue("false"!==f.getStored("issue-tt-use-structure")),g=new d.CheckboxPresenter(t,a),t.pipeChanges(function(a){f.setStored("issue-tt-use-structure",a?"true":"false")}),(new c(I,H,t,function(a,b,l){return b?l?3:2:a?1:0})).pipe(
function(a){k&&k.toggle(0!==a);0!==a&&(b("#tt_use_structure").toggle(1!==a),b("#tt_info_structure").toggle(3===a),b("#tt_info_non_structure").toggle(3!==a))}))}function u(){var a=h.value();a&& !d.deepEquals(a,n)&&(n=a,m(a,0))}function m(g,c){var k= !1,q= !1;f.ajax.doAjax({url:E(g,c),cache: !1,dataType:"html",success:function(s){k= !0;n===g&&h.value()&&(s=b(s),(c=d.toIntSafe(s.find("#tt_structure_job_id").data("jobId")))?a.delay(a.partial(m,g,c),1E3):(q= !0,r(s)))},complete:function(){if(n===g&&(q&&(n=null),!k&&h.value())){d.warn("did not receive reply from STTS");var a=b("#s-timetrackingmodule");a.length?a.show():b("#timetrackingmodule").show()}}})}function E(a,g){var b=f.ajsbridge.localURL("/secure/StructureTimeTrackingSection.jspa?decorator=none");g?b+="&jobId="+g:(b+="&structureId="+a.structureId,b=a.rowId?b+("&rowId="+a.rowId):b+("&issueId="+a.issueId));return b}var t=new c(!0),g=null,H=new c(!1),I=new c(!1),A="",k=null,h=new c(B,p,function(a,b){return a&&b&&(b.rowId||b.issueId)?{rowId:b.rowId,issueId:b.issueId,structureId:a}:null}),n=null;b(function(){var a=window.JIRA;a&&"function"===typeof a.bind&&a.Events&&a.Events.ISSUE_REFRESHED&&a.bind(a.Events.ISSUE_REFRESHED,function()
{if(h.value())try{k&&b("#timetrackingmodule").hide(),u()}catch(a){d.warn("problem processing time tracking update",a)}})});h.pipeChanges(u);d.extend(this,{restoreJiraTimetrackingModule:x,trackStructureUpdates:function(a){function b(a){return a&& !a.empty};var g={};g[z.POLL_RESULT]=function(a){a=a.forests&&a.forests.some(b)? !1:a.items&& !a.items.empty? !1: !0;a||u()};a.addListener(new d.Life,g)},loadTimeTracking:u})}});define("structure/page/issue/IssuePageDecorator","almworks/jquery almworks/util/Util almworks/util/Cell structure/page/issue/TimeTrackingController structure/page/issue/IssuePageParams structure/page/issue/StructureSectionController structure/page/issue/IssuePageSettingsDialog structure/page/PageWidgetConfig structure/page/PageDecoration".split(" "),function(b,a,c,d,v,e,q,y,x){var f=namespace("almworks.structure");return function(){function a(b){var f=(new c(r,function(a){return a&&a.getSettingsCell()})).flatten(!0),m=(new c(r,function(a){return a&&a.getUploadingCell()|| !1})).flatten(),d=b.find("#s-uioptions");d.hide();f.pipeOnce(function(a){return! !a},function(){d.show();new q({trigger:"#s-uioptions",settings:f,configuration:w,uploading:m})})}f.modes.ISSUE_PAGE= !
0;b("body").addClass("s-page-issue");var B=null,p=v.getIssuePageParamsCell(),r=(new c(p.field("issueId"),function(a){return a?new y({forIssue:a}):null})).shallowEquality(),w=(new c(r,function(a){return a&&a.getConfigCell()})).flatten(),u=new c(null),m=new c(p,u,w,function(a,b,c){return a.structureEnabled?null!==b?b:c&&c.initialStructure&&c.initialStructure.id:null}),E=new c(p,function(a){return{issueId:a&&a.issueId||null}}),t=new d(m,E);new e({configuration:w,onModuleInserted:function(b){a(b)},onWidgetCreated:function(a){B=a;t.trackStructureUpdates(a.eventBus);a.getPrimaryStructureIdCell().pipe(u);x.connectWidgetAndSingleStructureMode(w,B)}});p.pipe(function(a){a.panelMissing||a.structureEnabled||t.restoreJiraTimetrackingModule()})}});define("structure/page/issue/IssuePageParams",["almworks/jquery","almworks/util/Cell","almworks/util/Types"],function(b,a,c){function d(){var a=b("#s-helper-panel-content");if(!a.length)return v;var d={};d.issueId=c.toIntSafe(a.attr("data-issue-id"));d.issueKey=a.attr("data-issue-key")||"";d.structureEnabled="true"===a.attr("data-show-structure");d.initiallyUnstructured="true"===a.attr("data-unstructured");d.initiallyAutoCollapsed="true"===a.attr(
"data-auto-collapsed");d.usedNavigationHint="true"===a.attr("data-used-navigation-hint");Object.freeze(d);return d}var v={issueId:0,issueKey:"",structureEnabled: !1,initiallyUnstructured: !0,initiallyAutoCollapsed: !0,panelMissing: !0};Object.freeze(v);var e=null;return{getIssuePageParamsCell:function(){if(e)return e;e=new a(d());var c=window.JIRA;c&&"function"===typeof c.bind&&c.Events&&(c.Events.ISSUE_REFRESHED?c.bind(c.Events.ISSUE_REFRESHED,function(){e.setValueForced(d())}):c.Events.NEW_CONTENT_ADDED&&c.bind(c.Events.NEW_CONTENT_ADDED,function(a,c,f){("pageLoad"===f||"panelRefreshed"===f&&c&&"function"!==typeof c&&"structure-helper-panel"===b(c).attr("id"))&&e.setValue(d())}));return e}}});define("structure/page/issue/IssuePageSettingsDialog","almworks/util/Template almworks/util/Util almworks/util/Cell almworks/util/CellPresenter almworks/util/Objects almworks/util/Classes structure/page/PageSettingsDialog".split(" "),function(b,a,c,d,v,e,q){function y(a){q.call(this,a)}function x(a,b){e.addSuper(d.CellPresenter,this)(a,b,!1)}a.extend(y.prototype,q.prototype,{_buildContent:function(f){f.empty();f.append(b.load("structure.page.issue.settings-dialog").render$().saveBindings(
this._$));var e=this._options.settings;f=this._options.configuration;new d.CheckboxPresenter(e.field("autoCollapse"),this._$.autoCollapse);new d.CheckboxPresenter(e.field("keepStructureWhenNavigating"),this._$.keepStructure);e=e.field("autoSwitch");new x(e,{autoSwitch:this._$.autoSwitch,"default":this._$.autoSwitchToDefault,withIssue:this._$.autoSwitchToWithIssue});e=new c(e,function(a){return "default"===a||"withIssue"===a});f=f.field("userConfigurable");var q=this._$.dialog.find(".s-autoswitch-opt"),p=q.find("input");(new c(f,e,a.and)).pipe(function(b){a.toggleAttr(p,"disabled",b?null:"disabled");q.toggleClass("s-disabled",!b)});var r=this._$.dialog.find(".s-uid-content input,label").not(p);f.pipe(function(b){r.filter("label").toggleClass("s-disabled",!b);a.toggleAttr(r.filter("input"),"disabled",b?null:"disabled")});this._commonDialogInit()}});v.extend(x.prototype,d.CellPresenter.prototype,{updateView:function(b){this.view&&(a.toggleAttr(this.view.autoSwitch,"checked","default"===b||"withIssue"===b?"checked": !1),a.toggleAttr(this.view["default"],"checked","default"===b?"checked": !1),a.toggleAttr(this.view.withIssue,"checked","withIssue"===b?"checked": !1))},getViewValue:
function(){return this.view&&this.view.autoSwitch.is(":checked")?this.view["default"].is(":checked")?"default":"withIssue":"off"},subscribeToViewEvents:function(b){if(this.view){var c=a.withThis(this,this.viewChanged),d=["autoSwitch","default","withIssue"];d.forEach(function(a){this.view[a].bind("change.AutoSwitchPresenter keyup.AutoSwitchPresenter click.AutoSwitchPresenter",c)},this);var e=this;b.addDetach(function(){d.forEach(function(a){e.view[a].unbind(".AutoSwitchPresenter")})})}}});return y});define("structure/page/issue/StructureSectionController","almworks/jquery almworks/util/Util almworks/util/Cell almworks/util/Template structure/page/issue/IssuePageParams structure/page/issue/IssuePageUtil structure/widget/model/Items structure/page/PageDecoration structure/widget/ui/UIUtil".split(" "),function(b,a,c,d,v,e,q,y,x){function f(b,c){function d(b,m){var h=q.getIssueIdFromItemId(b.itemId);if(m&&h){var e=c.value().issueId;try{var l;if(!(l=h===e||z(h)))a:{var t=window.JIRA&&window.JIRA.Issue;if(t&&"function"===typeof t.getSubtaskModule)try{var p=t.getSubtaskModule();if(p&&"function"===typeof p.find){var r=p.find("tr.issuerow[rel="+h+"]");if(r&&r.length){l= !0;break a}}}catch(s)
{}l= !1}l&&f.trigger(g.REFRESH_ISSUE_PAGE,[e])}catch(D){a.warn("problem refreshing issue",D)}}}var g=namespace("JIRA.Events",!1),f=namespace("JIRA",!1),e;b&&g&&g.REFRESH_ISSUE_PAGE&&"function"===typeof f.trigger&&(e={},e[w.EDIT_UPLOAD_FINISHED]=d,b.eventBus.addListener(new a.Life,e))}function z(c){var d=b("#linkingmodule"),e= !1;d.length&&d.find("dd[id]").each(function(){var d=b(this).attr("id");if((d=u.exec(d))&&a.toIntSafe(d[1])===c)return e= !0,!1});return e}function B(c){var d=namespace("JIRA.Dialogs.editLabels",!1);if(d){var e=d.labelsProvider;"function"===typeof e&&(d.labelsProvider=function(d){var f=d.$activeTrigger,p=c.value().issueId;return f&&f.parents("#structuremodule").length&&(f=a.toIntSafe(f.attr("data-issueId")))&&p&&p!==f?b():e.apply(this,arguments)})}}function p(){var a=namespace("JIRA.Issue",!1),b=namespace("JIRA.Dialog",!1),c=a&&a.getIssueId,d=a&&a.refreshSubtasks,e=b&&b.getAttrFromActiveTrigger;"function"===typeof c&&"function"===typeof e&&(a.getIssueId=function(){return b.current&&e("data-issueId")||c()},"function"===typeof d&&(a.refreshSubtasks=function(){return a.getIssueId()===c()?d():{done:function(a){"function"===typeof a&&a()}}}))}var r=namespace(
"almworks.structure"),w=namespace("almworks.structure.appevents"),u=/^internal-(\d+)_/;return function(m){function q(){function d(){var b=h&&a.onPage(h)? !h.is(".collapsed"):null;z.setValue(b)}b(".mod-header h2",h).click(function(){window.setTimeout(d,10)});(new c(l,function(a){return a.panelMissing|| !a.issueId?null: !(!a.initiallyUnstructured|| !a.initiallyAutoCollapsed||a.usedNavigationHint)})).pipe(function(b){null!==b&&(b=e.isCollapsedModule("#structuremodule")||b,a.updateClasses(h,b?["collapsed"]:["expanded"],["collapsed","expanded"]),d())})}function t(){var b=a.text("s.iv.module.title");(new c(m.configuration,F,z,function(b,c,d){if(!b||null===d)return null;var e="",s="";c&&c.name?(e=c.name,s=c.description||""):b.initialStructure&&(c=b.initialStructure,e=c.name||"",s=c.description||"");r.modes.GH_TAB||(e=a.abbreviateLabel(e));return{name:e,description:s,sectionHeaderShowsStructureName: !d&& !b.singleStructure}})).pipe(function(a){if(a){var c=k.header;if(c){var d,e;a.name?a.sectionHeaderShowsStructureName?(d=a.name,d=b+": "+d,e=a.description||""):(d=b,e=a.name,a.description&&(e+=" - "+a.description)):d=b;c.text(d);e?c.attr("title",e):c.removeAttr("title")}}})}function g(){(
new c(G,l,function(a,b){return null!==a?a: !(!b.structureEnabled|| !b.initiallyUnstructured)})).pipe(function(a){h.toggleClass("s-unstructured",a)})}function u(){var c=new(require("structure/widget/widget"))(b("#structure"),{height:"model",maxRows:15,hideable: !0}),d=l.value().issueId;c.setAnchorIssue(d,!0,!0);c.setInitiallySelectedIssueFromLocation(d);c.setErrorsEnabled(function(){var a=l.value();return 0<a.issueId&&a.structureEnabled? !0:"dismiss"});y.connectWidgetAndInitialStructure(m.configuration,c);a.safeCall(m&&m.onWidgetCreated,m,c);f(c,l);w();c.master.getInfoCell().pipe(F);c.getPrimaryPanelRootPathsCell().pipe(function(a){G.setValue(a&& !a.length)});c.makeFooterResponsive();return c}function w(){var b=a.delayed(100,function(){a.onPage(h)&&n.forceLayout()});window.AJS.$("body").on("drag",".navigator-content .split-view",b)}function A(a){h&&(h.detach(),a&&n&&n.errorCentral.dismissAllErrors())}var k={},h=null,n=null,l=v.getIssuePageParamsCell(),z=new c(null),F=new c(null),G=new c(null);z.pipeChanges(function(a){a&&(null===n?n=u():n.forceLayout())});l.pipe(function(c){if(!c.structureEnabled)A(!0);else if(c.issueId&&(!h|| !a.onPage(h))){var e;e=b("#activitymodule");e.length||(
e=b("#addcomment"),e.length||(e=b("#primary").find(".content > div:last")));if(e=e.length?e:null){if(h){var f=l.value().issueId;b.browser&&b.browser.msie||x.deleteSkateJsData(h);h.detach().insertBefore(e).show();if(n&&(n.reinstallAJSMouseHandler(),n.setAnchorIssue(f,!0,!0),r.reviveHelpPanels(n),n.reviveIssueActionDropDowns(),n.forceLayout(),x.rebindAJSListeners(),e=window.JIRA,f=window.AJS,e&&e.trigger&&f&&f.$))try{e.trigger(e.Events.NEW_CONTENT_ADDED,[f.$(h[0]),"structureSectionReinserted"])}catch(u){a.warn("caught exception when notifying about page change",u)}a.safeCall(m&&m.onModuleReinserted,m,h)}else d.load("structure.page.issue.structure-section").render$().saveBindings(k).insertBefore(e),h=k["#structuremodule"],q(),t(),g(),B(l),p(),a.safeCall(m&&m.onModuleInserted,m,h);c=c.issueKey;h.find("#unstructured-warning").text(a.text("s.w.iv.unstructured.warning",c)).attr("title",a.text("s.w.iv.unstructured.description",c))}else a.warn("nowhere to add structure module")}});(function(){function c(a){try{a&&a.initialize&&A(!1)}catch(b){}}if(b.browser&&b.browser.msie){var d=window.JIRA;if(d&&d.Issues&&d.Issues.Application)try{d.Issues.Application.request("issueEditor").model.on(
"updated",c)}catch(e){a.warn("Could not install IE workaround for HJ-2110",e)}else try{var f=require("jira/components/issueviewer/entities/issue"),g=f.prototype.update;f.prototype.update=function(a,b){c(b);return g.apply(this,arguments)}}catch(l){a.warn("Could not install IE workaround for HJ-2110",l)}try{var k=namespace("JIRA.Issues.IssueNavCreator.searchPageModule.search",!1),m=k&&k.getResults&&k.getResults(),p=m&&m.getSelectedIssue&&m.getSelectedIssue(),n= !1;if(p)p.on("change:id",function(){var a=k.isStandAloneIssue&&k.isStandAloneIssue(),b=m.hasSelectedIssue&&m.hasSelectedIssue();a||(b?n?n= !1:x.deleteSkateJsData(h):(A(!1),n= !0))})}catch(q){a.warn("Could not install IE workaround for HJ-2139",q)}}})()}});(function(){var b=require("almworks/jquery"),a=require("structure/page/issue/IssuePageDecorator");b(function(){b("#structure").length||new a})})();window.almworks||(window.almworks={});window.almworks.template||(window.almworks.template={});window.almworks.template["structure.page.issue.structure-section"]=
'<div id="structuremodule" class="module toggle-wrap">\n<div class="mod-header">\n<ul class="s-ops">\n<li>\n<a href="#" id="s-uioptions" class="s-atlas-cog" style="display:none" title="{s.w.uisettings.tooltip}">\n<span>{s.w.uisettings.title}</span>\n</a>\n</li>\n</ul>\n<h2 class="toggle-title" data-bind-id="header">{s.iv.module.title}</h2>\n<span id="unstructured-warning"></span>\n</div>\n<div id="structuremodule-content" class="mod-content">\n<div id="structure"></div>\n</div>\n</div>';window.almworks.template["structure.page.issue.settings-dialog"]=
'<div class="s-uiopts" data-bind-id="dialog">\n<form class="aui ajs-dirty-warning-exempt">\n<header><h2>{s.w.uisettings.title}</h2></header>\n<fieldset class="group s-uid-content">\n<div class="checkbox s-hide-single-structure">\n<label><input class="checkbox" type="checkbox" data-bind-id="autoSwitch"> {s.w.uisettings.autoswitch.label}</label>\n</div>\n<div class="radio s-autoswitch-opt s-indent s-hide-single-structure">\n<label><input class="radio" type="radio" checked="checked" name="autoselect_type" value="withIssue" data-bind-id="autoSwitchToWithIssue"> {s.w.uisettings.autoswitch.withIssue}</label>\n</div>\n<div class="radio s-autoswitch-opt s-indent s-hide-single-structure">\n<label><input class="radio" type="radio" name="autoselect_type" value="default" data-bind-id="autoSwitchToDefault"> {s.w.uisettings.autoswitch.default} <span id="s-uid-defaultname">?</span></label>\n</div>\n<div class="checkbox s-m10 s-hide-single-structure">\n<label><input class="checkbox" type="checkbox" data-bind-id="keepStructure"> {s.w.uisettings.keepstructure.label}</label>\n</div>\n<div class="checkbox">\n<label><input class="checkbox" type="checkbox" id="s-uid-autocollapse" data-bind-id="autoCollapse"> {s.w.uisettings.autocollapse.label}</label>\n</div>\n</fieldset>\n<div class="buttons">\n<div id="s-uid-working-icon" data-bind-id="working"></div>\n<a class="cancel" title="{s.w.uisettings.help.title}" href="http://almworks.com/structure/help/uisettings" target="_blank"><span>Help</span></a>\n<input class="button submit" data-bind-id="close" type="button" value="{s.w.uisettings.close}"/>\n</div>\n</form>\n</div>';
 ;